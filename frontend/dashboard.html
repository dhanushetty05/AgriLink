<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Dashboard | AgriLink</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header style="background:#2e7d32;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;">
    <h2>üåæ Farmer Dashboard</h2>
    <button id="logoutBtn" style="background:white;color:#2e7d32;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">Logout</button>
  </header>

  <main style="padding:20px;">
    <h3>Add New Product</h3>
    <form id="addProductForm">
      <input type="text" id="name" placeholder="Crop Name" required><br><br>
      <input type="number" id="price" placeholder="Price per kg" required><br><br>
      <input type="number" id="quantity" placeholder="Quantity (kg)" required><br><br>
      <input type="text" id="location" placeholder="Location" required><br><br>
      <button type="submit" style="background:#2e7d32;color:white;padding:8px 15px;border:none;border-radius:4px;cursor:pointer;">Add Product</button>
    </form>

    <hr>
    <h3>Your Products</h3>
    <div id="productList"></div>
  </main>

  <script>
    // ‚úÖ Immediate role and login validation
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.role.toLowerCase() !== "farmer") {
      alert("Access denied! Only farmers can view this page.");
      window.location.href = "marketplace.html";
    }
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const user = JSON.parse(localStorage.getItem("user"));
      const token = localStorage.getItem("token");

      if (!user || !token) {
        alert("Please log in first");
        window.location.href = "login.html";
        return;
      }

      const form = document.getElementById("addProductForm");
      const list = document.getElementById("productList");

      // ‚úÖ Add new product
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const product = {
          name: document.getElementById("name").value.trim(),
          price: document.getElementById("price").value,
          quantity: document.getElementById("quantity").value,
          location: document.getElementById("location").value.trim(),
        };

        try {
          const res = await fetch("http://localhost:5000/api/products", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(product),
          });

          const data = await res.json();

          if (res.ok) {
            alert("‚úÖ Product added successfully!");
            form.reset();
            loadProducts();
          } else {
            alert("‚ùå " + (data.message || "Error adding product"));
          }
        } catch (error) {
          console.error("Add product error:", error);
          alert("‚ö†Ô∏è Failed to add product");
        }
      });

      // ‚úÖ Load all farmer products
      async function loadProducts() {
        try {
          const res = await fetch(`http://localhost:5000/api/products/farmer/${user._id}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const products = await res.json();
          list.innerHTML = "";

          if (!Array.isArray(products) || products.length === 0) {
            list.innerHTML = "<p>No products added yet.</p>";
            return;
          }

          products.forEach((p) => {
            const div = document.createElement("div");
            div.classList.add("product-item");
            div.style.marginBottom = "8px";
            div.innerHTML = `
              <strong>${p.name}</strong> ‚Äî ‚Çπ${p.price}/kg, ${p.quantity}kg (${p.location})
              <button class="delete-btn" data-id="${p._id}" style="margin-left:10px;background:#c62828;color:white;border:none;padding:3px 6px;border-radius:3px;cursor:pointer;">üóëÔ∏è</button>
            `;
            list.appendChild(div);
          });

          // ‚úÖ Attach delete event listener for all delete buttons
          document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.addEventListener("click", () => deleteProduct(btn.dataset.id));
          });
        } catch (error) {
          console.error("Load products error:", error);
          list.innerHTML = "<p>‚ö†Ô∏è Failed to load products.</p>";
        }
      }

      // ‚úÖ Delete a product
      async function deleteProduct(id) {
        if (!confirm("Delete this product?")) return;

        try {
          const res = await fetch(`http://localhost:5000/api/products/${id}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const data = await res.json();
          alert(data.message || "Deleted successfully");
          loadProducts();
        } catch (error) {
          console.error("Delete error:", error);
          alert("‚ö†Ô∏è Failed to delete product");
        }
      }

      // ‚úÖ Logout function
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = "login.html";
      });

      // Initial load
      loadProducts();
    });
  </script>
</body>
</html>
